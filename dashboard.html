<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Last Dance - ê°ì • ê¸°ë°˜ ìŒì•… ì¶”ì²œ</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='dashborad.css') }}" />
</head>
<body>
<header class="header">
  <div class="container">
    <div class="header-content">
      <div class="logo-section">
        <div class="logo">Last Dance</div>
        <div class="logo-subtitle">ê°ì • ê¸°ë°˜ ìŒì•… ì¶”ì²œ</div>
      </div>
      <div class="header-buttons">
        <a href="{{ url_for('profile.profile') }}" class="btn btn-primary">í”„ë¡œí•„</a>
        <a href="{{ url_for('public.logout') }}" class="btn btn-red">ë¡œê·¸ì•„ì›ƒ</a>
      </div>
    </div>
  </div>
</header>

<main class="main">
  <div class="container">
    <div class="welcome-section">
      <h1 class="welcome-title">ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h1>
      <p class="welcome-text">ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë– ì…¨ë‚˜ìš”? ì¼ê¸°ë¥¼ ì‘ì„±í•˜ê³  ë§ì¶¤ ìŒì•…ì„ ë“¤ì–´ë³´ì„¸ìš”.</p>
      <div class="user-info">
        <p class="user-email">
          <strong>ì´ë©”ì¼:</strong>
          <span class="email-value" id="userEmail">{{ session['user']['email'] if session.get('user') and session['user'].get('email') else 'ë¡œê·¸ì¸ í•„ìš”' }}</span>
        </p>
      </div>
    </div>

    <div class="quick-actions">
      <button onclick="writeDiary()" class="action-card">
        <div class="action-content">
          <div class="action-icon">âœï¸</div>
          <div class="action-text"><h3>ìƒˆ ì¼ê¸° ì‘ì„±</h3><p>ì˜¤ëŠ˜ì˜ ê°ì •ì„ ê¸°ë¡í•´ë³´ì„¸ìš”</p></div>
        </div>
      </button>
      <button onclick="showRecommendedMusic()" class="action-card blue">
        <div class="action-content">
          <div class="action-icon">ğŸµ</div>
          <div class="action-text"><h3>ì¶”ì²œ ìŒì•…</h3><p>ê°ì •ì— ë§ëŠ” ìŒì•… ë“£ê¸°</p></div>
        </div>
      </button>
      <button onclick="showEmotionCalendar()" class="action-card green">
        <div class="action-content">
          <div class="action-icon">ğŸ“…</div>
          <div class="action-text"><h3>ê°ì • ìº˜ë¦°ë”</h3><p>ê°ì • ë³€í™” ì¶”ì´ ë³´ê¸°</p></div>
        </div>
      </button>
    </div>

    <div class="main-grid">
      <div class="left-column">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ğŸ“– ìµœê·¼ ì¼ê¸°</h2>
            <a href="/api/diary/all" class="card-link">ëª¨ë‘ ë³´ê¸°</a>
          </div>
          <div class="diary-list"></div>
        </div>
        <div class="card">
          <h2 class="card-title">ğŸ“ˆ ì´ë²ˆ ì£¼ ê°ì • ì¶”ì´</h2>
          <div class="weekly-chart">
            {% for day in ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'] %}
            <div class="chart-day"><div class="chart-bar" style="height: 0px;"></div><span class="chart-emoji">â“</span><span class="chart-label">{{ day }}</span></div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="right-column">
        <div class="card">
          <h2 class="card-title">â¤ï¸ ì˜¤ëŠ˜ì˜ ê°ì •</h2>
          <div class="emotion-display">
            <div class="emotion-large">ğŸ˜</div>
            <div class="emotion-tag emotion-neutral">ì¤‘ë¦½</div>
          </div>
        </div>

        <div class="card">
          <h2 class="card-title">ğŸµ ì¶”ì²œ ìŒì•…</h2>
          <div class="music-player" id="currentlyPlaying">
            <div class="song-info">
              <div class="song-title" id="currentSongTitle">ì¬ìƒ ì¤‘ì¸ ìŒì•… ì—†ìŒ</div>
              <div class="song-artist" id="currentSongArtist">-</div>
            </div>
            <div class="player-controls">
              <button onclick="togglePlay()" class="control-btn"><span id="playIcon">â–¶ï¸</span></button>
            </div>
          </div>
          <div class="music-list" id="musicList">
            <p>ìŒì•…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
          </div>
        </div>

        <div class="card">
  <h2 class="card-title">ğŸ“Š ì´ë²ˆ ë‹¬ í†µê³„</h2>
  <div class="stats-list">
    <div class="stat-item">
      <span class="stat-label">ì‘ì„±í•œ ì¼ê¸°</span>
      <span class="stat-value" id="stat-diary-count">-</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">í‰ê·  ê°ì • ì ìˆ˜</span>
      <span class="stat-value" id="stat-avg-score">-</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">ë“¤ì€ ìŒì•…</span>
      <span class="stat-value">ë³´ë¥˜</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">ê°€ì¥ ë§ì€ ê°ì •</span>
      <span class="stat-value" id="stat-top-emotion">-</span>
    </div>
  </div>
</div>
</main>

<script>
let currentAudio = new Audio();
let isPlaying = false;

async function loadTodayEmotion() {
  try {
    const res = await fetch('/api/diary/last-emotion');
    const data = await res.json();
    console.log('ğŸ“Œ ë§ˆì§€ë§‰ ê°ì •:', data);

    const emojiMap = {
      neutral: 'ğŸ˜',
      joy: 'ğŸ˜„',
      sadness: 'ğŸ˜¢',
      anger: 'ğŸ˜¡',
      fear: 'ğŸ˜¨',
      disgust: 'ğŸ¤¢',
      surprise: 'ğŸ˜²'
    };

    // âœ… ìˆ˜ì •ëœ ë¶€ë¶„: emotion ëŒ€ì‹  main_emotion ì‚¬ìš©
    const emotion = data.main_emotion?.toLowerCase() || 'neutral';
    const emoji = emojiMap[emotion] || 'ğŸ˜';
    const krLabel = emotion_kr(emotion);

    document.querySelector('.emotion-large').textContent = emoji;
    document.querySelector('.emotion-tag').textContent = krLabel;
  } catch (err) {
    console.error('âŒ ì˜¤ëŠ˜ì˜ ê°ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
  }
}



function emotion_kr(label) {
  const map = {
    neutral: 'ì¤‘ë¦½', joy: 'ê¸°ì¨', sadness: 'ìŠ¬í””', anger: 'ë¶„ë…¸',
    fear: 'ë‘ë ¤ì›€', disgust: 'í˜ì˜¤', surprise: 'ë†€ëŒ'
  };
  return map[label] || 'ì¤‘ë¦½';
}

async function getLastEmotion() {
  try {
    const res = await fetch('/api/diary/last-emotion');
    const data = await res.json();
    return data.emotion || 'neutral';  // âœ… ì—¬ê¸°ë„ "emotion" í‚¤ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸
  } catch (err) {
    console.error('ê°ì • ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err);
    return 'neutral';
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  loadRecentDiaries();
  loadTodayEmotion();

  const emotion = await getLastEmotion();  // â† ê°€ì¥ ìµœê·¼ ê°ì • ë°›ì•„ì˜¤ê¸°
  await loadSpotifyRecommendations(emotion);  // â† ì§ì ‘ ì „ë‹¬
});

async function loadSpotifyRecommendations(emotion) {
  const list = document.getElementById('musicList');
  list.innerHTML = '<p>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

  try {
    const res = await fetch('/api/music/recommend', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ emotion })  // â† ì—¬ê¸°ì„œ ì™¸ë¶€ì—ì„œ ë°›ì€ emotion ì‚¬ìš©
    });

    const data = await res.json();
    const tracks = data.recommendations;

    if (!tracks.length) {
      list.innerHTML = '<p>ì¶”ì²œ ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    list.innerHTML = '';
    tracks.forEach(track => {
      const item = document.createElement('div');
      item.className = 'music-item';
      item.innerHTML = `
        <div class="music-info">
          <h4>${track.title}</h4>
          <div class="artist">${track.artist}</div>
          <div class="reason">${track.reason || 'ìŠ¤í¬í‹°íŒŒì´ ì¶”ì²œ'}</div>
        </div>
        <a class="play-icon" href="${track.url}" target="_blank">â–¶ï¸</a>
      `;
      list.appendChild(item);
    });
  } catch (e) {
    list.innerHTML = '<p>ìŒì•…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
    console.error(e);
  }
}


function togglePlay() {
  if (!currentAudio.src) return;
  isPlaying = !isPlaying;
  isPlaying ? currentAudio.play() : currentAudio.pause();
  document.getElementById('playIcon').textContent = isPlaying ? 'â¸ï¸' : 'â–¶ï¸';
}

function writeDiary() {
  window.location.href = "/write-diary";
}

function showRecommendedMusic() {
  loadSpotifyRecommendations();
  window.scrollTo({ top: document.getElementById('musicList').offsetTop, behavior: 'smooth' });
}

function showEmotionCalendar() {
  window.location.href = "/calendar";
}


async function loadRecentDiaries() {
  const list = document.querySelector('.diary-list');
  try {
    const res = await fetch('/api/diary/recent');
    const diaries = await res.json();
    if (!diaries.length) return;
    list.innerHTML = '';
    diaries.forEach(diary => {
      const item = document.createElement('div');
      item.className = 'diary-item';
      item.innerHTML = `
        <div class="diary-snippet">${diary.content.slice(0, 50)}...</div>
        <div class="diary-meta">ê°ì •: ${diary.main_emotion} / ì ìˆ˜: ${diary.score.toFixed(2)}</div>
      `;
      list.appendChild(item);
    });
  } catch (err) {
    list.innerHTML = '<p>ì¼ê¸° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>';
    console.error(err);
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  loadRecentDiaries();
  loadTodayEmotion();

  const emotion = await getLastEmotion();
  await loadSpotifyRecommendations(emotion);

  // ğŸ“Š ì´ë²ˆ ë‹¬ í†µê³„ ë¶ˆëŸ¬ì˜¤ê¸°
  try {
    const res = await fetch("/api/diary/monthly-stats");
    const data = await res.json();

    const diaryCountEl = document.getElementById("stat-diary-count");
    const avgScoreEl = document.getElementById("stat-avg-score");
    const topEmotionEl = document.getElementById("stat-top-emotion");

    if (diaryCountEl && avgScoreEl && topEmotionEl) {
      diaryCountEl.innerText = data.diary_count + "ê°œ";
      avgScoreEl.innerText = data.average_score;
      topEmotionEl.innerText = `${data.most_common_emotion_emoji} ${data.most_common_emotion_kr}`;
    }
  } catch (err) {
    console.error("ğŸ“‰ í†µê³„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
  }
  loadWeeklyEmotions();
});

async function loadWeeklyEmotions() {
  const emojiMap = {
    joy: "ğŸ˜„", sadness: "ğŸ˜¢", anger: "ğŸ˜¡", fear: "ğŸ˜¨",
    disgust: "ğŸ¤¢", surprise: "ğŸ˜²", neutral: "ğŸ˜"
  };
  const response = await fetch('/api/diary/weekly-emotions');
  const data = await response.json();
  const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const dayEls = document.querySelectorAll('.weekly-chart .chart-day');

  dayEls.forEach((el, index) => {
    const engDay = days[index];
    const emoji = emojiMap[data[engDay]] || "â“";
    el.querySelector('.chart-emoji').textContent = emoji;
  });
}

</script>
</body>
</html>